# TextLoom 数据库管理

## 概述

`init_database.py` 是 TextLoom 项目的统一数据库管理工具，包含了数据库初始化、表管理、状态检查和系统验证的所有功能。

## 使用方法

```bash
# 显示帮助信息
uv run python init_database.py

# 创建schema和所有数据库表
uv run python init_database.py create

# 检查数据库表状态
uv run python init_database.py check

# 只创建schema（不创建表）
uv run python init_database.py schema

# 删除所有表（谨慎使用）
uv run python init_database.py drop

# 重置数据库（删除后重建）
uv run python init_database.py reset

# 完整系统验证（推荐）
uv run python init_database.py verify

# 检查模型与数据库差异
uv run python init_database.py diff

# 执行数据库迁移
uv run python init_database.py migrate
```

## 主要功能

### 1. 数据库表创建 (`create`)
- 自动创建 `textloom_core` schema
- 创建所有必需的数据库表
- 包含完整的外键约束和索引
- 兼容 pgbouncer 连接池

### 2. 状态检查 (`check`)
- 列出 `textloom_core` schema 中的所有表
- 显示表的创建状态

### 3. 系统验证 (`verify`)
- 验证数据库连接
- 检查 PostgreSQL 版本
- 验证 schema 存在性
- 检查所有表是否正确创建
- 验证 TextLoom 服务运行状态
- 提供完整的系统健康报告

### 4. 数据库重置 (`reset`)
- 安全删除所有表
- 重新创建 schema 和表
- 适用于开发环境的完全重置

### 5. Schema差异检查 (`diff`)
- 分析当前数据库结构
- 对比模型定义与实际数据库
- 识别需要迁移的变更

### 6. 数据库迁移 (`migrate`)
- 创建迁移跟踪表
- 执行增量schema变更
- 自动检测和应用缺失的字段
- 记录迁移历史

## 数据库架构

### 核心表结构

1. **video_projects** - 视频项目表
2. **tasks** - 任务表
3. **media_items** - 媒体素材表  
4. **material_analyses** - 素材分析表
5. **personas** - 人设表
6. **prompt_templates** - 提示词模板表
7. **script_contents** - 脚本内容表
8. **sub_video_tasks** - 子视频任务表

### Schema 设计
- 所有表都在 `textloom_core` schema 中
- 使用 UUID 作为主键
- 包含完整的时间戳字段
- 支持 JSONB 字段存储复杂数据

## 技术特性

### pgbouncer 兼容性
- 禁用 prepared statements (`statement_cache_size=0`)
- 避免事务冲突问题
- 直接使用 asyncpg 连接，绕过 SQLAlchemy 的连接池问题

### 错误处理
- 完整的异常捕获和日志记录
- 友好的错误提示信息
- 操作确认机制（删除操作需要确认）

## 最佳实践

1. **首次部署**：
   ```bash
   uv run python init_database.py create
   ```

2. **日常检查**：
   ```bash
   uv run python init_database.py verify
   ```

3. **开发环境重置**：
   ```bash
   uv run python init_database.py reset
   ```

4. **生产环境**：
   - 不要使用 `drop` 或 `reset` 命令
   - 定期运行 `verify` 检查系统状态
   - 使用 `check` 监控表状态

## 注意事项

- `drop` 和 `reset` 操作会删除所有数据，请谨慎使用
- 所有危险操作都需要用户确认
- 脚本会自动处理表之间的依赖关系
- 支持在 pgbouncer 环境下安全运行

## 模型变更处理流程

当您在 `models/db_models.py` 中修改模型时，需要同步到数据库：

### 1. 添加新字段
修改模型文件后：
```python
# 在 models/db_models.py 中添加新字段
class TaskTable(Base):
    # ... 现有字段
    new_field = Column(String(100), nullable=True, comment="新字段")
```

然后执行迁移：
```bash
# 检查差异
uv run python init_database.py diff

# 执行迁移
uv run python init_database.py migrate
```

### 2. 自定义迁移
对于复杂变更，需要在 `init_database.py` 的 `migrate_database()` 函数中添加自定义逻辑：

```python
# 在 migrate_database() 函数中添加
if 'new_field' not in existing_columns:
    migrations.append("""
        ALTER TABLE textloom_core.your_table 
        ADD COLUMN new_field VARCHAR(100)
    """)
```

### 3. 迁移最佳实践
- 总是先运行 `diff` 检查变更
- 在生产环境前先在开发环境测试迁移
- 重要变更前备份数据库
- 使用版本控制跟踪迁移历史

### 4. 支持的变更类型
- ✅ 添加新字段（可空字段）
- ✅ 添加新表
- ✅ 添加索引
- ⚠️ 修改字段类型（需要自定义迁移）
- ⚠️ 删除字段（需要手动处理）
- ❌ 删除表（需要手动确认）

## 故障排除

如果遇到连接问题：
1. 检查数据库配置 (`config.py`)
2. 确认 pgbouncer 配置正确
3. 运行 `verify` 命令获取详细信息

如果表创建失败：
1. 检查数据库权限
2. 确认 schema 存在
3. 查看详细的错误日志

如果迁移失败：
1. 检查迁移跟踪表状态
2. 手动执行失败的SQL语句
3. 使用 `diff` 命令确认当前状态