[unix_http_server]
file=/tmp/supervisor.sock
chmod=0700
chown=backup:backup

[supervisord]
logfile=/var/log/supervisor/supervisord.log
logfile_maxbytes=50MB
logfile_backups=10
loglevel=info
pidfile=/tmp/supervisord.pid
nodaemon=true
minfds=1024
minprocs=200
user=backup

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock

# 备份监控服务
[program:backup-monitor]
command=/usr/local/bin/python /app/scripts/backup_monitor.py start
directory=/app
user=backup
autostart=true
autorestart=true
startsecs=10
startretries=3
stdout_logfile=/app/logs/backup_monitor.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=3
stderr_logfile=/app/logs/backup_monitor.error.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=3
environment=PYTHONPATH="/app"
priority=100

# 备份仪表板服务
[program:backup-dashboard]
command=/usr/local/bin/python /app/scripts/backup_monitor.py dashboard --host 0.0.0.0 --port 8080
directory=/app
user=backup
autostart=true
autorestart=true
startsecs=10
startretries=3
stdout_logfile=/app/logs/backup_dashboard.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=3
stderr_logfile=/app/logs/backup_dashboard.error.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=3
environment=PYTHONPATH="/app"
priority=200

# Cron调度服务
[program:crond]
command=/usr/sbin/crond -f -d 8
user=root
autostart=true
autorestart=true
startsecs=5
startretries=3
stdout_logfile=/app/logs/cron.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=3
stderr_logfile=/app/logs/cron.error.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=3
priority=50

# 系统监控服务（可选）
[program:system-monitor]
command=/usr/local/bin/python -c "
import time, psutil, json, os
while True:
    stats = {
        'cpu_percent': psutil.cpu_percent(interval=1),
        'memory_percent': psutil.virtual_memory().percent,
        'disk_usage': psutil.disk_usage('/').percent,
        'timestamp': time.time()
    }
    with open('/app/logs/system_stats.json', 'w') as f:
        json.dump(stats, f)
    time.sleep(60)
"
directory=/app
user=backup
autostart=false
autorestart=true
startsecs=5
startretries=3
stdout_logfile=/app/logs/system_monitor.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=2
stderr_logfile=/app/logs/system_monitor.error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=2
priority=300

# 备份状态检查服务
[program:backup-health-check]
command=/bin/bash -c "
while true; do
    echo '[Health Check] Running backup system health check...'
    if /usr/local/bin/python /app/scripts/disaster_recovery.py assess > /tmp/health_check.json 2>&1; then
        echo '[Health Check] System health check passed'
    else
        echo '[Health Check] System health check failed'
    fi
    sleep 300  # 5分钟检查一次
done
"
directory=/app
user=backup
autostart=true
autorestart=true
startsecs=30
startretries=3
stdout_logfile=/app/logs/health_check.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=2
stderr_logfile=/app/logs/health_check.error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=2
environment=PYTHONPATH="/app"
priority=400

# 日志轮转服务
[program:log-rotator]
command=/bin/bash -c "
while true; do
    find /app/logs -name '*.log' -size +100M -exec gzip {} \;
    find /app/logs -name '*.log.gz' -mtime +30 -delete
    sleep 3600  # 1小时检查一次
done
"
directory=/app
user=backup
autostart=true
autorestart=true
startsecs=10
startretries=3
stdout_logfile=/dev/null
stderr_logfile=/app/logs/log_rotator.error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=2
priority=500

[group:backup-services]
programs=backup-monitor,backup-dashboard,backup-health-check
priority=999