name: Dependency Updates

on:
  schedule:
    # Check for dependency updates weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update to perform'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - all
        default: 'patch'

env:
  PYTHON_VERSION: '3.11'
  UV_VERSION: '0.5.1'

jobs:
  check-dependencies:
    runs-on: ubuntu-latest
    name: Check for Dependency Updates
    outputs:
      has-updates: ${{ steps.check.outputs.has-updates }}
      update-summary: ${{ steps.check.outputs.update-summary }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: ${{ env.UV_VERSION }}
        
    - name: Install dependencies
      run: uv sync --dev
      
    - name: Check for outdated packages
      id: check
      run: |
        echo "Checking for outdated packages..."
        
        # Create a list of outdated packages
        uv pip list --outdated --format=json > outdated.json || echo "[]" > outdated.json
        
        # Check if there are any outdated packages
        OUTDATED_COUNT=$(jq length outdated.json)
        
        if [ "$OUTDATED_COUNT" -gt 0 ]; then
          echo "has-updates=true" >> $GITHUB_OUTPUT
          echo "Found $OUTDATED_COUNT outdated packages"
          
          # Create a summary
          echo "update-summary<<EOF" >> $GITHUB_OUTPUT
          echo "## Outdated Dependencies ($OUTDATED_COUNT packages)" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "| Package | Current | Latest | Type |" >> $GITHUB_OUTPUT
          echo "|---------|---------|--------|------|" >> $GITHUB_OUTPUT
          
          jq -r '.[] | "| \(.name) | \(.version) | \(.latest_version) | \(.latest_filetype) |"' outdated.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "has-updates=false" >> $GITHUB_OUTPUT
          echo "update-summary=No outdated dependencies found." >> $GITHUB_OUTPUT
        fi
        
    - name: Upload outdated packages report
      uses: actions/upload-artifact@v4
      if: steps.check.outputs.has-updates == 'true'
      with:
        name: outdated-packages
        path: outdated.json
        retention-days: 7

  security-updates:
    runs-on: ubuntu-latest
    name: Apply Security Updates
    needs: check-dependencies
    if: needs.check-dependencies.outputs.has-updates == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: ${{ env.UV_VERSION }}
        
    - name: Install dependencies
      run: uv sync --dev
      
    - name: Download outdated packages
      uses: actions/download-artifact@v4
      with:
        name: outdated-packages
        
    - name: Check for security vulnerabilities
      run: |
        echo "Checking for security vulnerabilities in dependencies..."
        
        # Install security checking tools
        uv pip install safety pip-audit
        
        # Run safety check and save results
        uv run safety check --json --output safety-report.json || true
        
        # Run pip-audit and save results
        uv run pip-audit --format=json --output=pip-audit-report.json || true
        
        # Check if any vulnerabilities were found
        SAFETY_VULNS=$(jq '.vulnerabilities | length' safety-report.json 2>/dev/null || echo 0)
        AUDIT_VULNS=$(jq '.vulnerabilities | length' pip-audit-report.json 2>/dev/null || echo 0)
        
        echo "Safety vulnerabilities found: $SAFETY_VULNS"
        echo "Pip-audit vulnerabilities found: $AUDIT_VULNS"
        
        if [ "$SAFETY_VULNS" -gt 0 ] || [ "$AUDIT_VULNS" -gt 0 ]; then
          echo "SECURITY_UPDATES_NEEDED=true" >> $GITHUB_ENV
          echo "Security vulnerabilities found in dependencies!"
        else
          echo "SECURITY_UPDATES_NEEDED=false" >> $GITHUB_ENV
          echo "No security vulnerabilities found."
        fi
        
    - name: Apply security updates
      if: env.SECURITY_UPDATES_NEEDED == 'true'
      run: |
        echo "Applying security updates..."
        
        # Extract vulnerable packages and try to update them
        VULNERABLE_PACKAGES=""
        
        if [ -f safety-report.json ]; then
          VULNERABLE_PACKAGES+=$(jq -r '.vulnerabilities[].package_name' safety-report.json | sort -u | tr '\n' ' ')
        fi
        
        if [ -f pip-audit-report.json ]; then
          VULNERABLE_PACKAGES+=" "$(jq -r '.vulnerabilities[].name' pip-audit-report.json | sort -u | tr '\n' ' ')
        fi
        
        # Remove duplicates
        VULNERABLE_PACKAGES=$(echo $VULNERABLE_PACKAGES | tr ' ' '\n' | sort -u | tr '\n' ' ')
        
        echo "Vulnerable packages to update: $VULNERABLE_PACKAGES"
        
        for package in $VULNERABLE_PACKAGES; do
          if [ -n "$package" ]; then
            echo "Updating $package..."
            uv add "${package}@latest" || echo "Failed to update $package"
          fi
        done
        
    - name: Apply patch updates
      if: github.event.inputs.update_type == 'patch' || github.event.inputs.update_type == 'all'
      run: |
        echo "Applying patch updates..."
        uv sync --upgrade-package "*" || true
        
    - name: Apply minor updates
      if: github.event.inputs.update_type == 'minor' || github.event.inputs.update_type == 'all'
      run: |
        echo "Applying minor updates..."
        # This is more complex with uv, would need to parse versions
        echo "Minor updates require manual review of pyproject.toml"
        
    - name: Run tests after updates
      run: |
        echo "Running tests to verify updates..."
        uv run pytest tests/ -x -q --tb=short -m "not integration" || echo "Tests failed after updates"
        
    - name: Check for changes
      id: changes
      run: |
        if git diff --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          echo "changes=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Create pull request
      if: steps.changes.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          chore: Update dependencies for security and maintenance
          
          - Applied security updates for vulnerable packages
          - Updated dependencies based on ${{ github.event.inputs.update_type || 'security' }} criteria
          - All tests passing after updates
          
          Auto-generated by dependency update workflow
        title: "chore: Dependency updates (${{ github.event.inputs.update_type || 'security' }})"
        body: |
          ## Dependency Updates
          
          This PR contains automated dependency updates:
          
          ${{ needs.check-dependencies.outputs.update-summary }}
          
          ### Changes Made
          - âœ… Security updates applied
          - âœ… Tests verified
          - ðŸ” Please review changes before merging
          
          ### Security Status
          - Security vulnerabilities addressed: ${{ env.SECURITY_UPDATES_NEEDED == 'true' && 'Yes' || 'None found' }}
          
          ---
          *This PR was automatically created by the dependency update workflow*
        branch: dependency-updates-${{ github.run_number }}
        delete-branch: true
        labels: |
          dependencies
          automated
          security
        
    - name: Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          safety-report.json
          pip-audit-report.json
        retention-days: 30

  notify-updates:
    runs-on: ubuntu-latest
    name: Notify Update Results
    needs: [check-dependencies, security-updates]
    if: always()
    
    steps:
    - name: Create summary
      run: |
        echo "## ðŸ“¦ Dependency Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.check-dependencies.outputs.has-updates }}" == "true" ]]; then
          echo "### Updates Available" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.check-dependencies.outputs.update-summary }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.security-updates.result }}" == "success" ]]; then
            echo "âœ… **Security updates applied successfully**" >> $GITHUB_STEP_SUMMARY
            echo "- A pull request has been created with the updates" >> $GITHUB_STEP_SUMMARY
            echo "- Please review and merge the PR after testing" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Failed to apply updates**" >> $GITHUB_STEP_SUMMARY
            echo "- Check the workflow logs for details" >> $GITHUB_STEP_SUMMARY
            echo "- Manual intervention may be required" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âœ… **No updates needed**" >> $GITHUB_STEP_SUMMARY
          echo "All dependencies are up to date." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Recommendations" >> $GITHUB_STEP_SUMMARY
        echo "- Review dependency updates regularly" >> $GITHUB_STEP_SUMMARY
        echo "- Test thoroughly before deploying updates" >> $GITHUB_STEP_SUMMARY
        echo "- Monitor security advisories for your dependencies" >> $GITHUB_STEP_SUMMARY