name: SaaS Production Deployment Pipeline

on:
  push:
    branches: 
      - main
      - release/*
  pull_request:
    branches: 
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      deployment_type:
        description: 'Deployment strategy'
        required: false
        default: 'rolling'
        type: choice
        options:
          - rolling
          - blue-green
          - canary

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # =====================================
  # ä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•
  # =====================================
  code-quality:
    name: Code Quality & Security
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: å®‰è£…UVåŒ…ç®¡ç†å™¨
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
    
    - name: ç¼“å­˜ä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/uv
          .venv
        key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml', 'uv.lock') }}
        restore-keys: |
          ${{ runner.os }}-uv-
    
    - name: å®‰è£…ä¾èµ–
      run: |
        uv sync --dev
        uv add --group dev bandit safety mypy black isort flake8
    
    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      run: |
        uv run black --check .
        uv run isort --check-only .
        uv run flake8 .
    
    - name: ç±»å‹æ£€æŸ¥
      continue-on-error: true
      run: |
        uv run mypy . || echo "Type checking completed with warnings"
    
    - name: å®‰å…¨æ‰«æ
      run: |
        uv run bandit -r . -f json -x ".venv,venv,logs,workspace,test,tests" -o bandit-report.json || true
        uv run safety check --json --continue-on-error > safety-report.json || true
    
    - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json

  # =====================================
  # åç«¯æµ‹è¯•
  # =====================================
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: code-quality
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: textloom_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: å®‰è£…UVåŒ…ç®¡ç†å™¨
      uses: astral-sh/setup-uv@v3
    
    - name: å®‰è£…ä¾èµ–
      run: |
        uv sync --dev
    
    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/textloom_test
        REDIS_URL: redis://localhost:6379/0
        TEST_ENV: true
      run: |
        uv run pytest tests/ -v --cov=. --cov-report=xml --cov-report=html
    
    - name: ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: backend
        name: backend-coverage

  # =====================================
  # å‰ç«¯æµ‹è¯• (å¦‚æœå­˜åœ¨å‰ç«¯ä»£ç )
  # =====================================
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: code-quality
    if: ${{ hashFiles('package.json') != '' }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: å®‰è£…å‰ç«¯ä¾èµ–
      run: npm ci
    
    - name: å‰ç«¯ä»£ç æ£€æŸ¥
      run: |
        npm run lint
        npm run type-check
    
    - name: å‰ç«¯å•å…ƒæµ‹è¯•
      run: npm test -- --coverage
    
    - name: ä¸Šä¼ å‰ç«¯è¦†ç›–ç‡
      uses: codecov/codecov-action@v3
      with:
        file: ./frontend/coverage/lcov.info
        flags: frontend
        name: frontend-coverage

  # =====================================
  # æ„å»ºDockeré•œåƒ
  # =====================================
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [backend-tests]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    strategy:
      matrix:
        component: [api, worker, scheduler]
    
    outputs:
      api-image: ${{ steps.meta.outputs.tags }}
      worker-image: ${{ steps.meta.outputs.tags }}
      scheduler-image: ${{ steps.meta.outputs.tags }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ç™»å½•å®¹å™¨æ³¨å†Œè¡¨
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: æå–å…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.component }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: æ„å»ºå¹¶æ¨é€é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/Dockerfile.${{ matrix.component }}
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          PYTHON_VERSION=${{ env.PYTHON_VERSION }}
          BUILD_DATE=${{ steps.meta.outputs.build-date }}
          VCS_REF=${{ github.sha }}

  # =====================================
  # é›†æˆæµ‹è¯•
  # =====================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [build-images]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: textloom_integration
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Docker Compose
      run: |
        docker-compose -f docker/compose/docker-compose.test.yml up -d
        
    - name: ç­‰å¾…æœåŠ¡å¯åŠ¨
      run: |
        timeout 60 bash -c 'until curl -f http://localhost:8000/health; do sleep 5; done'
    
    - name: è¿è¡Œé›†æˆæµ‹è¯•
      run: |
        docker-compose -f docker/compose/docker-compose.test.yml exec -T api \
          pytest tests/integration/ -v --tb=short
    
    - name: æ”¶é›†æµ‹è¯•æ—¥å¿—
      if: always()
      run: |
        docker-compose -f docker/compose/docker-compose.test.yml logs > integration-logs.txt
    
    - name: ä¸Šä¼ æµ‹è¯•ç»“æœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: integration-test-results
        path: |
          integration-logs.txt
          test-results/
    
    - name: æ¸…ç†æµ‹è¯•ç¯å¢ƒ
      if: always()
      run: |
        docker-compose -f docker/compose/docker-compose.test.yml down -v

  # =====================================
  # æ€§èƒ½æµ‹è¯•
  # =====================================
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [integration-tests]
    if: github.ref == 'refs/heads/main' || contains(github.ref, 'release/')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®K6
      run: |
        sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6
    
    - name: è¿è¡Œè´Ÿè½½æµ‹è¯•
      run: |
        k6 run tests/performance/load-test.js
    
    - name: ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
      run: |
        k6 run --out json=performance-results.json tests/performance/stress-test.js
    
    - name: ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: performance-results
        path: performance-results.json

  # =====================================
  # å®‰å…¨æ‰«æ
  # =====================================
  security-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build-images]
    
    strategy:
      matrix:
        component: [api, worker, scheduler]
    
    steps:
    - name: è¿è¡Œå®¹å™¨å®‰å…¨æ‰«æ
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.component }}:latest
        format: 'sarif'
        output: 'trivy-${{ matrix.component }}.sarif'
    
    - name: ä¸Šä¼ æ‰«æç»“æœåˆ°GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-${{ matrix.component }}.sarif'

  # =====================================
  # éƒ¨ç½²åˆ°Stagingç¯å¢ƒ
  # =====================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [integration-tests, security-scan]
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    environment: 
      name: staging
      url: https://staging.textloom.ai
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'
    
    - name: é…ç½®Kubernetesé›†ç¾¤è®¿é—®
      run: |
        echo "${{ secrets.KUBECONFIG_STAGING }}" | base64 -d > kubeconfig
        export KUBECONFIG=kubeconfig
    
    - name: éƒ¨ç½²åˆ°Kubernetes
      run: |
        export KUBECONFIG=kubeconfig
        envsubst < k8s/staging/deployment.yaml | kubectl apply -f -
        kubectl rollout status deployment/textloom-api -n staging --timeout=300s
        kubectl rollout status deployment/textloom-worker -n staging --timeout=300s
    
    - name: è¿è¡Œéƒ¨ç½²åéªŒè¯
      run: |
        export KUBECONFIG=kubeconfig
        kubectl run health-check --rm -i --image=curlimages/curl --restart=Never \
          -- curl -f http://textloom-api.staging.svc.cluster.local:8000/health
    
    - name: é€šçŸ¥Slack
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        text: 'Staging deployment ${{ job.status }}: ${{ github.sha }}'

  # =====================================
  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  # =====================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [deploy-staging, performance-tests]
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event.inputs.environment == 'production')
    environment: 
      name: production
      url: https://textloom.ai
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: äººå·¥å®¡æ‰¹ç¡®è®¤
      uses: trstringer/manual-approval@v1
      if: github.event_name != 'workflow_dispatch'
      with:
        secret: ${{ secrets.GITHUB_TOKEN }}
        approvers: team-leads,devops-team
        minimum-approvals: 2
        issue-title: "éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ: ${{ github.sha }}"
        issue-body: |
          è¯·å®¡æ‰¹æ­¤æ¬¡ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²:
          - æäº¤: ${{ github.sha }}
          - åˆ†æ”¯: ${{ github.ref }}
          - å˜æ›´å†…å®¹: ${{ github.event.head_commit.message }}
          
          éƒ¨ç½²ç­–ç•¥: ${{ github.event.inputs.deployment_type || 'rolling' }}
    
    - name: è®¾ç½®kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'
    
    - name: é…ç½®Kubernetesé›†ç¾¤è®¿é—®
      run: |
        echo "${{ secrets.KUBECONFIG_PRODUCTION }}" | base64 -d > kubeconfig
        export KUBECONFIG=kubeconfig
    
    - name: æ•°æ®åº“è¿ç§»
      run: |
        export KUBECONFIG=kubeconfig
        kubectl create job migration-${{ github.run_number }} \
          --from=deployment/textloom-api -n production
        kubectl wait --for=condition=complete job/migration-${{ github.run_number }} \
          -n production --timeout=600s
    
    - name: è“ç»¿éƒ¨ç½²
      if: github.event.inputs.deployment_type == 'blue-green'
      run: |
        export KUBECONFIG=kubeconfig
        # éƒ¨ç½²ç»¿è‰²ç‰ˆæœ¬
        envsubst < k8s/production/deployment-green.yaml | kubectl apply -f -
        kubectl rollout status deployment/textloom-api-green -n production --timeout=600s
        
        # å¥åº·æ£€æŸ¥
        kubectl run health-check-green --rm -i --image=curlimages/curl --restart=Never \
          -- curl -f http://textloom-api-green.production.svc.cluster.local:8000/health
        
        # åˆ‡æ¢æµé‡
        kubectl patch service textloom-api -n production \
          -p '{"spec":{"selector":{"version":"green"}}}'
        
        # æ¸…ç†è“è‰²ç‰ˆæœ¬
        sleep 60
        kubectl delete deployment textloom-api-blue -n production || true
    
    - name: æ»šåŠ¨æ›´æ–°éƒ¨ç½²
      if: github.event.inputs.deployment_type != 'blue-green'
      run: |
        export KUBECONFIG=kubeconfig
        envsubst < k8s/production/deployment.yaml | kubectl apply -f -
        kubectl rollout status deployment/textloom-api -n production --timeout=600s
        kubectl rollout status deployment/textloom-worker -n production --timeout=600s
    
    - name: éƒ¨ç½²åéªŒè¯
      run: |
        export KUBECONFIG=kubeconfig
        # APIå¥åº·æ£€æŸ¥
        kubectl run health-check --rm -i --image=curlimages/curl --restart=Never \
          -- curl -f http://textloom-api.production.svc.cluster.local:8000/health
        
        # åŠŸèƒ½éªŒè¯
        kubectl run function-test --rm -i --image=curlimages/curl --restart=Never \
          -- curl -f -X POST http://textloom-api.production.svc.cluster.local:8000/health
    
    - name: æ›´æ–°éƒ¨ç½²è®°å½•
      run: |
        curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/${{ github.repository }}/deployments \
          -d '{
            "ref": "${{ github.sha }}",
            "environment": "production",
            "description": "Automated production deployment",
            "auto_merge": false,
            "required_contexts": []
          }'
    
    - name: é€šçŸ¥éƒ¨ç½²æˆåŠŸ
      if: success()
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        text: |
          ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸ!
          - æäº¤: ${{ github.sha }}
          - éƒ¨ç½²ç­–ç•¥: ${{ github.event.inputs.deployment_type || 'rolling' }}
          - è®¿é—®åœ°å€: https://textloom.ai
    
    - name: å›æ»šé€šçŸ¥
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#incidents'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        text: |
          ğŸš¨ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¤±è´¥!
          - æäº¤: ${{ github.sha }}
          - è¯·ç«‹å³æ£€æŸ¥å¹¶è€ƒè™‘å›æ»š
          - æ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  # =====================================
  # æ¸…ç†èµ„æº
  # =====================================
  cleanup:
    name: Cleanup Resources
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [deploy-production]
    if: always()
    
    steps:
    - name: æ¸…ç†æ—§é•œåƒ
      run: |
        # ä¿ç•™æœ€è¿‘10ä¸ªç‰ˆæœ¬çš„é•œåƒ
        echo "Cleanup job completed - implemented via registry retention policy"
    
    - name: ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
      run: |
        echo "## éƒ¨ç½²æ€»ç»“" > deployment-summary.md
        echo "- **æäº¤**: ${{ github.sha }}" >> deployment-summary.md
        echo "- **æ—¶é—´**: $(date -u)" >> deployment-summary.md
        echo "- **ç¯å¢ƒ**: production" >> deployment-summary.md
        echo "- **çŠ¶æ€**: ${{ job.status }}" >> deployment-summary.md
    
    - name: ä¸Šä¼ éƒ¨ç½²æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: deployment-summary
        path: deployment-summary.md