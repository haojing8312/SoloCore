name: Security Scan

on:
  # æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main, develop ]
  
  # PRæ—¶è§¦å‘
  pull_request:
    branches: [ main ]
  
  # å®šæœŸæ‰«æ (æ¯å‘¨ä¸€ä¸Šåˆ6ç‚¹ UTC)
  schedule:
    - cron: '0 6 * * 1'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      severity_threshold:
        description: 'ä¸¥é‡ç¨‹åº¦é˜ˆå€¼'
        required: false
        default: 'medium'
        type: choice
        options:
          - critical
          - high
          - medium
          - low
      scan_type:
        description: 'æ‰«æç±»å‹'
        required: false
        default: 'quick'
        type: choice
        options:
          - quick
          - full

jobs:
  security-scan:
    name: ä¾èµ–å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    strategy:
      matrix:
        python-version: ['3.11']
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: å®‰è£… UV åŒ…ç®¡ç†å™¨
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: ç¼“å­˜ä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/uv
          .venv
        key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml', 'uv.lock') }}
        restore-keys: |
          ${{ runner.os }}-uv-
          
    - name: å®‰è£…é¡¹ç›®ä¾èµ–
      run: |
        uv sync --dev
        
    - name: å®‰è£…å®‰å…¨æ‰«æå·¥å…·
      run: |
        uv add --group dev safety pip-audit bandit semgrep
        
    - name: åˆ›å»ºæŠ¥å‘Šç›®å½•
      run: |
        mkdir -p security_reports/ci
        
    - name: è¿è¡Œ Safety å®‰å…¨æ‰«æ
      id: safety
      continue-on-error: true
      run: |
        echo "::group::Safety ä¾èµ–æ¼æ´æ‰«æ"
        uv run safety check --json --continue-on-error > security_reports/ci/safety_results.json 2>&1 || true
        echo "::endgroup::"
        
    - name: è¿è¡Œ pip-audit å®‰å…¨æ‰«æ
      id: pip-audit
      continue-on-error: true
      run: |
        echo "::group::pip-audit ä¾èµ–å®¡è®¡"
        uv run pip-audit --format=json --desc > security_reports/ci/pip_audit_results.json 2>&1 || true
        echo "::endgroup::"
        
    - name: è¿è¡Œ Bandit ä»£ç å®‰å…¨æ‰«æ
      id: bandit
      continue-on-error: true
      run: |
        echo "::group::Bandit ä»£ç å®‰å…¨æ‰«æ"
        uv run bandit -r . -f json --exclude .venv,venv,logs,workspace,test,tests > security_reports/ci/bandit_results.json 2>&1 || true
        echo "::endgroup::"
        
    - name: è¿è¡Œå¿«é€Ÿæ¼æ´æ‰«æ
      id: quick-scan
      continue-on-error: true
      run: |
        echo "::group::å¿«é€Ÿå®‰å…¨æ‰«æ"
        chmod +x scripts/security_automation.sh
        ./scripts/security_automation.sh quick-scan --severity ${{ github.event.inputs.severity_threshold || 'medium' }} --output json
        echo "::endgroup::"
        
    - name: ç”Ÿæˆå®‰å…¨æŠ¥å‘Šæ‘˜è¦
      id: summary
      run: |
        echo "::group::ç”Ÿæˆæ‰«ææ‘˜è¦"
        
        # ç»Ÿè®¡æ‰«æç»“æœ
        safety_issues=0
        audit_issues=0
        bandit_issues=0
        
        # æ£€æŸ¥ Safety ç»“æœ
        if [ -f security_reports/ci/safety_results.json ]; then
          safety_issues=$(cat security_reports/ci/safety_results.json | jq 'length // 0' 2>/dev/null || echo "0")
        fi
        
        # æ£€æŸ¥ pip-audit ç»“æœ
        if [ -f security_reports/ci/pip_audit_results.json ]; then
          audit_issues=$(cat security_reports/ci/pip_audit_results.json | jq '.vulnerabilities | length // 0' 2>/dev/null || echo "0")
        fi
        
        # æ£€æŸ¥ Bandit ç»“æœ
        if [ -f security_reports/ci/bandit_results.json ]; then
          bandit_issues=$(cat security_reports/ci/bandit_results.json | jq '.results | length // 0' 2>/dev/null || echo "0")
        fi
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "safety_issues=${safety_issues}" >> $GITHUB_OUTPUT
        echo "audit_issues=${audit_issues}" >> $GITHUB_OUTPUT  
        echo "bandit_issues=${bandit_issues}" >> $GITHUB_OUTPUT
        
        total_issues=$((safety_issues + audit_issues + bandit_issues))
        echo "total_issues=${total_issues}" >> $GITHUB_OUTPUT
        
        echo "::notice::å®‰å…¨æ‰«ææ‘˜è¦ - Safety: ${safety_issues}, pip-audit: ${audit_issues}, Bandit: ${bandit_issues}, æ€»è®¡: ${total_issues}"
        echo "::endgroup::"
        
    - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports-${{ github.run_id }}
        path: security_reports/
        retention-days: 30
        
    - name: åˆ›å»ºå®‰å…¨æ‰«æè¯„è®º (PR)
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          let comment = `## ğŸ” å®‰å…¨æ‰«æç»“æœ\n\n`;
          comment += `**æ‰«ææ—¶é—´**: ${new Date().toISOString()}\n`;
          comment += `**è§¦å‘äº‹ä»¶**: ${context.eventName}\n\n`;
          
          // æ·»åŠ æ‰«æç»“æœæ‘˜è¦
          const safetyIssues = ${{ steps.summary.outputs.safety_issues }};
          const auditIssues = ${{ steps.summary.outputs.audit_issues }};
          const banditIssues = ${{ steps.summary.outputs.bandit_issues }};
          const totalIssues = ${{ steps.summary.outputs.total_issues }};
          
          if (totalIssues === 0) {
            comment += `âœ… **æ‰«æç»“æœ**: æœªå‘ç°å®‰å…¨é—®é¢˜\n\n`;
          } else {
            comment += `âš ï¸ **æ‰«æç»“æœ**: å‘ç° ${totalIssues} ä¸ªæ½œåœ¨é—®é¢˜\n\n`;
            comment += `| æ‰«æå·¥å…· | å‘ç°é—®é¢˜ |\n`;
            comment += `|----------|----------|\n`;
            comment += `| Safety | ${safetyIssues} |\n`;
            comment += `| pip-audit | ${auditIssues} |\n`;
            comment += `| Bandit | ${banditIssues} |\n\n`;
          }
          
          comment += `ğŸ“Š **è¯¦ç»†æŠ¥å‘Š**: è¯·æŸ¥çœ‹ GitHub Actions å·¥ä»¶ä¸­çš„å®Œæ•´æ‰«ææŠ¥å‘Š\n\n`;
          comment += `### å»ºè®®æ“ä½œ\n`;
          if (totalIssues > 0) {
            comment += `- ğŸ” æ£€æŸ¥è¯¦ç»†æ‰«ææŠ¥å‘Šä¸­çš„å…·ä½“é—®é¢˜\n`;
            comment += `- ğŸ“¦ è€ƒè™‘æ›´æ–°ç›¸å…³ä¾èµ–åŒ…\n`;
            comment += `- ğŸ” ä¿®å¤æ ‡è¯†çš„ä»£ç å®‰å…¨é—®é¢˜\n`;
          }
          comment += `- â° å®šæœŸè¿è¡Œå®‰å…¨æ‰«æ\n`;
          comment += `- ğŸ“‹ å»ºç«‹å®‰å…¨å“åº”æµç¨‹\n`;
          
          // å‘å¸ƒè¯„è®º
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
    - name: æ£€æŸ¥å®‰å…¨é˜ˆå€¼ (å¤±è´¥æ¡ä»¶)
      if: always()
      run: |
        total_issues=${{ steps.summary.outputs.total_issues }}
        safety_issues=${{ steps.summary.outputs.safety_issues }}
        
        echo "æ€»é—®é¢˜æ•°: $total_issues"
        echo "Safety ä¸¥é‡é—®é¢˜: $safety_issues"
        
        # è®¾ç½®å¤±è´¥æ¡ä»¶
        # 1. Safety å‘ç°ä»»ä½•å·²çŸ¥æ¼æ´
        # 2. æ€»é—®é¢˜æ•°è¶…è¿‡é˜ˆå€¼ (æ ¹æ®ä¸¥é‡ç¨‹åº¦è®¾ç½®)
        severity_threshold="${{ github.event.inputs.severity_threshold || 'medium' }}"
        
        case "$severity_threshold" in
          "critical")
            max_issues=0
            ;;
          "high")
            max_issues=5
            ;;
          "medium")
            max_issues=10
            ;;
          "low")
            max_issues=20
            ;;
          *)
            max_issues=10
            ;;
        esac
        
        if [ "$safety_issues" -gt 0 ]; then
          echo "::error::å‘ç° $safety_issues ä¸ªå·²çŸ¥å®‰å…¨æ¼æ´ï¼Œæ„å»ºå¤±è´¥"
          exit 1
        fi
        
        if [ "$total_issues" -gt "$max_issues" ]; then
          echo "::warning::å‘ç° $total_issues ä¸ªå®‰å…¨é—®é¢˜ï¼Œè¶…è¿‡é˜ˆå€¼ $max_issues"
          # å¯¹äºä¸­ä½ä¸¥é‡ç¨‹åº¦ï¼Œä»…è­¦å‘Šä¸å¤±è´¥
          if [ "$severity_threshold" = "critical" ] || [ "$severity_threshold" = "high" ]; then
            echo "::error::å®‰å…¨é—®é¢˜æ•°é‡è¶…è¿‡ $severity_threshold çº§åˆ«é˜ˆå€¼ï¼Œæ„å»ºå¤±è´¥"
            exit 1
          fi
        fi
        
        echo "::notice::å®‰å…¨æ‰«æé€šè¿‡ï¼Œé—®é¢˜æ•°é‡åœ¨å¯æ¥å—èŒƒå›´å†…"

  dependency-update-check:
    name: ä¾èµ–æ›´æ–°æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: å®‰è£… UV åŒ…ç®¡ç†å™¨
      uses: astral-sh/setup-uv@v3
      
    - name: å®‰è£…ä¾èµ–
      run: |
        uv sync --dev
        uv add --group dev requests packaging tomli
        
    - name: æ£€æŸ¥ä¾èµ–æ›´æ–°
      continue-on-error: true
      run: |
        echo "::group::æ£€æŸ¥ä¾èµ–æ›´æ–°"
        timeout 300 uv run python scripts/dependency_updater.py --priority high --output markdown > dependency_update_report.md 2>&1 || true
        echo "::endgroup::"
        
    - name: åˆ›å»ºä¾èµ–æ›´æ–° Issue
      if: github.event_name == 'schedule'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          // è¯»å–æ›´æ–°æŠ¥å‘Š
          let reportContent = '';
          try {
            reportContent = fs.readFileSync('dependency_update_report.md', 'utf8');
          } catch (error) {
            reportContent = 'æ— æ³•è¯»å–ä¾èµ–æ›´æ–°æŠ¥å‘Š';
          }
          
          const title = `ğŸ”„ ä¾èµ–æ›´æ–°å»ºè®® - ${new Date().toISOString().split('T')[0]}`;
          
          const body = `## è‡ªåŠ¨ä¾èµ–æ›´æ–°æ£€æŸ¥æŠ¥å‘Š
          
**ç”Ÿæˆæ—¶é—´**: ${new Date().toISOString()}
**æ£€æŸ¥ç±»å‹**: å®šæœŸè‡ªåŠ¨æ£€æŸ¥

### ğŸ“‹ æ›´æ–°æŠ¥å‘Š

\`\`\`markdown
${reportContent}
\`\`\`

### ğŸ¯ åç»­æ“ä½œ

- [ ] å®¡æŸ¥é«˜ä¼˜å…ˆçº§å®‰å…¨æ›´æ–°
- [ ] æµ‹è¯•å…³é”®ä¾èµ–æ›´æ–°
- [ ] æ›´æ–°ä¾èµ–å¹¶è¿è¡Œæµ‹è¯•
- [ ] æ›´æ–°é”å®šæ–‡ä»¶

**æ³¨æ„**: æ­¤æŠ¥å‘Šç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆã€‚è¯·ä»”ç»†å®¡æŸ¥å»ºè®®çš„æ›´æ–°ï¼Œç‰¹åˆ«æ˜¯æ¶‰åŠå®‰å…¨çš„æ›´æ–°ã€‚

---
*ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*`;

          // åˆ›å»ºæˆ–æ›´æ–°Issue
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'dependencies,security,automated'
          });
          
          const existingIssue = issues.find(issue => 
            issue.title.includes('ä¾èµ–æ›´æ–°å»ºè®®') && 
            issue.title.includes(new Date().toISOString().split('T')[0])
          );
          
          if (existingIssue) {
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: body
            });
          } else {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['dependencies', 'security', 'automated']
            });
          }