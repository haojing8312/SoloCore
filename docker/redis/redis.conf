# Redis 配置文件 - 测试环境
# 适用于开发和测试环境

# 网络配置
bind 0.0.0.0                            # 监听所有网络接口（测试环境）
protected-mode no                        # 关闭保护模式（测试环境）
port 6379                               # 默认端口
tcp-backlog 511                         # TCP 连接队列长度
timeout 0                               # 客户端超时时间（0表示禁用）
tcp-keepalive 300                       # TCP keepalive 时间

# 通用配置
daemonize no                            # 不以守护进程运行（Docker 环境）
pidfile /var/run/redis_6379.pid         # PID 文件路径
loglevel notice                         # 日志级别
logfile ""                              # 日志输出到 stdout
databases 16                            # 数据库数量

# 持久化 - RDB
save 900 1                              # 900秒内至少1个key变化则保存
save 300 10                             # 300秒内至少10个key变化则保存
save 60 10000                           # 60秒内至少10000个key变化则保存
stop-writes-on-bgsave-error yes         # RDB保存失败时停止写入
rdbcompression yes                      # 启用RDB压缩
rdbchecksum yes                         # 启用RDB校验
dbfilename dump.rdb                     # RDB文件名
dir /data                               # 数据目录

# 持久化 - AOF
appendonly yes                          # 启用AOF持久化
appendfilename "appendonly.aof"         # AOF文件名
appendfsync everysec                    # 每秒同步一次
no-appendfsync-on-rewrite no            # 重写时不进行fsync
auto-aof-rewrite-percentage 100         # AOF重写触发百分比
auto-aof-rewrite-min-size 64mb          # AOF重写最小文件大小

# 内存管理
maxmemory 256mb                         # 最大内存限制
maxmemory-policy allkeys-lru            # 内存淘汰策略（LRU）
maxmemory-samples 5                     # LRU采样数量

# 慢查询日志
slowlog-log-slower-than 10000           # 慢查询阈值（微秒）
slowlog-max-len 128                     # 慢查询日志最大长度

# 事件通知
notify-keyspace-events ""               # 键空间通知

# 客户端连接
maxclients 10000                        # 最大客户端连接数

# 高级配置
hash-max-ziplist-entries 512            # 哈希表压缩阈值
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# 活跃碎片整理
activedefrag yes                        # 启用活跃碎片整理
active-defrag-ignore-bytes 100mb        # 碎片整理忽略字节数
active-defrag-threshold-lower 10        # 碎片整理下限阈值
active-defrag-threshold-upper 100       # 碎片整理上限阈值
active-defrag-cycle-min 5               # 碎片整理CPU最小占用
active-defrag-cycle-max 75              # 碎片整理CPU最大占用

# 集群配置（单机模式不启用）
# cluster-enabled no

# 复制配置
replica-serve-stale-data yes            # 从节点在断开时继续提供服务
replica-read-only yes                   # 从节点只读
repl-diskless-sync no                   # 不使用无盘复制
repl-diskless-sync-delay 5              # 无盘复制延迟

# 安全配置
# requirepass 在 docker-compose.yml 中通过命令行参数设置
